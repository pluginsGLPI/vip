<?php
/*
 * @version $Id: HEADER 15930 2011-10-30 15:47:55Z tsmr $
 -------------------------------------------------------------------------
 vip plugin for GLPI
 Copyright (C) 2016-2022 by the vip Development Team.

 https://github.com/InfotelGLPI/vip
 -------------------------------------------------------------------------

 LICENSE

 This file is part of vip.

 vip is free software; you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation; either version 2 of the License, or
 (at your option) any later version.

 vip is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with vip. If not, see <http://www.gnu.org/licenses/>.
 --------------------------------------------------------------------------
 */

namespace GlpiPlugin\Vip;

use CommonGLPI;
use CommonITILActor;
use CommonITILObject;
use DBmysqlIterator;
use DbUtils;
use Group_User;
use Html;
use PluginMydashboardHelper;
use PluginMydashboardHtml;
use PluginMydashboardMenu;
use PluginMydashboardWidget;
use Session;
use Toolbox;

class Dashboard extends CommonGLPI
{
    public $widgets = [];
    private $options;
    private $datas;
    private $form;

    public function __construct($_options = [])
    {
        $this->options = $_options;
    }

     /**
      * @return \array[][]
      */
    public function getWidgetsForItem()
    {
        $widgets = [
            PluginMydashboardMenu::$HELPDESK => [
                $this->getType() . "1" => ["title"   => __("Tickets VIP", "mydashboard"),
                                           "type"    => PluginMydashboardWidget::$TABLE,
                                           "comment" => ""],
            ],
        ];

        return $widgets;
    }

    public function getWidgetContentForItem($widgetId)
    {
        global $DB;

        $dbu = new DbUtils();
        switch ($widgetId) {
            case $this->getType() . "1":
                $widget = new PluginMydashboardHtml();

                $link_ticket = Toolbox::getItemTypeFormURL("Ticket");

                $mygroups = Group_User::getUserGroups(Session::getLoginUserID(), ["is_assign" => 1]);
                $groups   = [];
                foreach ($mygroups as $mygroup) {
                    $groups[] = $mygroup["id"];
                }

                $criteria = [
                    'SELECT' => [
                        'glpi_tickets.id AS tickets_id', 'glpi_tickets.status AS status', 'glpi_tickets.time_to_resolve AS time_to_resolve'
                    ],
                    'FROM' => 'glpi_tickets',
                    'LEFT JOIN' => [
                        'glpi_entities' => [
                            'ON' => [
                                'glpi_tickets' => 'entities_id',
                                'glpi_entities' => 'id'
                            ]
                        ],
                        'glpi_groups_tickets' => [
                            'ON' => [
                                'glpi_tickets' => 'id',
                                'glpi_groups_tickets' => 'tickets_id', [
                                    'AND' => [
                                        'glpi_groups_tickets.type' => CommonITILActor::ASSIGN
                                    ]
                                ]
                            ]
                        ]
                    ],
                    'WHERE' => [
                        'glpi_tickets.is_deleted' => '0',
                        'NOT' => ['glpi_tickets.status' => [CommonITILObject::INCOMING, CommonITILObject::SOLVED, CommonITILObject::CLOSED]]
                    ],
                    'ORDER' => ['glpi_tickets.time_to_resolve' => 'DESC']
                ];
                if (count($groups) > 0) {
                    $criteria['WHERE']['glpi_groups_tickets.groups_id'] = $groups;
                }
                $it = new DBmysqlIterator($DB);
                $it->buildQuery($criteria);
                $widget  = PluginMydashboardHelper::getWidgetsFromDBQuery('table', $it->getSql());
                $headers = [__('ID'),
                            _n('Requester', 'Requesters', 2),
                            __('Status'),
                            __('Time to resolve'),
                            __('Assigned to technicians')];
                $widget->setTabNames($headers);

                $result = $DB->request($criteria);
                $nb     = count($result);

                $datas   = [];
                $tickets = [];

                if ($nb) {
                    foreach ($result as $data) {
                        $ticket = new \Ticket();
                        $ticket->getFromDB($data['tickets_id']);
                        if ($ticket->countUsers(CommonITILActor::REQUESTER)) {
                            $users = [];
                            foreach ($ticket->getUsers(CommonITILActor::REQUESTER) as $u) {
                                $users[] = $u['users_id'];
                            }
                            foreach ($users as $key => $val) {
                                if (Ticket::isUserVip($val) !== false) {
                                    $tickets[] = $data;
                                }
                            }
                        }
                    }
                    $i = 0;

                    foreach ($tickets as $key => $val) {
                        $ticket = new \Ticket();
                        $ticket->getFromDB($val['tickets_id']);

                        $bgcolor = $_SESSION["glpipriority_" . $ticket->fields["priority"]];

                        $name_ticket = "<div class='center' style='background-color:$bgcolor; padding: 10px;'>";
                        $name_ticket .= "<a href='" . $link_ticket . "?id=" . $val['tickets_id'] . "' target='_blank'>";
                        $name_ticket .= sprintf(__('%1$s: %2$s'), __('ID'), $val['tickets_id']);
                        $name_ticket .= "</a>";
                        $name_ticket .= "</div>";


                        $datas[$i]["tickets_id"] = $name_ticket;


                        $userdata = '';
                        if ($ticket->countUsers(CommonITILActor::REQUESTER)) {
                            foreach ($ticket->getUsers(CommonITILActor::REQUESTER) as $u) {
                                $k = $u['users_id'];
                                if ($k) {
                                    $userdata .= $dbu->getUserName($k);
                                }


                                if ($ticket->countUsers(CommonITILActor::REQUESTER) > 1) {
                                    $userdata .= "<br>";
                                }
                            }
                        }
                        $datas[$i]["users_id"] = $userdata;

                        $datas[$i]["status"] = \Ticket::getStatus($val['status']);

                        $time_to_resolve = '';
                        $due             = strtotime(date('Y-m-d H:i:s')) - strtotime($val['time_to_resolve']);
                        if ($due > 0) {
                            $time_to_resolve .= "<div class='center red'>";
                        }
                        $time_to_resolve .= Html::convDateTime($val['time_to_resolve']);
                        if ($due > 0) {
                            $time_to_resolve .= "</div>";
                        }
                        $datas[$i]["time_to_resolve"] = $time_to_resolve;

                        $techdata = '';
                        if ($ticket->countUsers(CommonITILActor::ASSIGN)) {
                            foreach ($ticket->getUsers(CommonITILActor::ASSIGN) as $u) {
                                $k = $u['users_id'];
                                if ($k) {
                                    $techdata .= getUserName($k);
                                }


                                if ($ticket->countUsers(CommonITILActor::ASSIGN) > 1) {
                                    $techdata .= "<br>";
                                }
                            }
                        }
                        $datas[$i]["techs_id"] = $techdata;
                        $i++;
                    }
                }

                $widget->setTabDatas($datas);
//            $widget->setOption("bSort", false);
                $widget->toggleWidgetRefresh();

                $widget->setWidgetTitle(__("Tickets VIP", "mydashboard"));

                return $widget;
                break;
        }
    }
}
